resources:
  jobs:
    faers_pipeline:
      name: faers_pipeline
      description: "Complete FAERS data lakehouse pipeline: Bronze ingestion → Silver transformations → Gold dimensional modeling"

      job_clusters:
        - job_cluster_key: "pipeline_cluster"
          new_cluster:
            spark_version: "17.2.x-scala2.13"
            node_type_id: "Standard_DS3_v2"
            num_workers: 2
            autotermination_minutes: 30
            spark_conf:
              "spark.databricks.delta.autoCompact.enabled": "true"
              "spark.databricks.delta.optimizeWrite.enabled": "true"
              "spark.sql.adaptive.enabled": "true"
              "spark.sql.adaptive.coalescePartitions.enabled": "true"
              "spark.sql.adaptive.skewJoin.enabled": "true"
            spark_env_vars:
              target_catalog: ${bundle.target}
            data_security_mode: "SINGLE_USER"

      tasks:
        # Bronze layer ingestion tasks
        - task_key: ingest_demographics
          spark_python_task:
            python_file: "../../src/bronze/ingest_demographics.py"
          job_cluster_key: "pipeline_cluster"

        - task_key: ingest_drug_details
          spark_python_task:
            python_file: "../../src/bronze/ingest_drug_details.py"
          job_cluster_key: "pipeline_cluster"

        - task_key: ingest_indications
          spark_python_task:
            python_file: "../../src/bronze/ingest_indications.py"
          job_cluster_key: "pipeline_cluster"

        - task_key: ingest_outcomes
          spark_python_task:
            python_file: "../../src/bronze/ingest_outcomes.py"
          job_cluster_key: "pipeline_cluster"

        - task_key: ingest_reactions
          spark_python_task:
            python_file: "../../src/bronze/ingest_reactions.py"
          job_cluster_key: "pipeline_cluster"

        - task_key: ingest_reports
          spark_python_task:
            python_file: "../../src/bronze/ingest_reports.py"
          job_cluster_key: "pipeline_cluster"

        - task_key: ingest_therapy_durations
          spark_python_task:
            python_file: "../../src/bronze/ingest_therapy_dates.py"
          job_cluster_key: "pipeline_cluster"

        # Silver layer transformation tasks (depend on bronze completion)
        - task_key: silver_demographics
          spark_python_task:
            python_file: "../../src/silver/silver_demographics.py"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: ingest_demographics

        - task_key: silver_drug_details
          spark_python_task:
            python_file: "../../src/silver/silver_drug_details.py"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: ingest_drug_details

        - task_key: silver_indications
          spark_python_task:
            python_file: "../../src/silver/silver_indications.py"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: ingest_indications

        - task_key: silver_outcomes
          spark_python_task:
            python_file: "../../src/silver/silver_outcomes.py"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: ingest_outcomes

        - task_key: silver_reactions
          spark_python_task:
            python_file: "../../src/silver/silver_reactions.py"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: ingest_reactions

        - task_key: silver_reports
          spark_python_task:
            python_file: "../../src/silver/silver_reports.py"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: ingest_reports

        - task_key: silver_therapy_durations
          spark_python_task:
            python_file: "../../src/silver/silver_therapy_dates.py"
          job_cluster_key: "pipeline_cluster"
          depends_on:
            - task_key: ingest_therapy_durations

        # Gold layer dimension tasks (depend on silver completion)
        - task_key: gold_dim_date
          spark_python_task:
            python_file: "../../src/gold/dims/dim_date.py"
          job_cluster_key: "pipeline_cluster"
          timeout_seconds: 3600
          depends_on:
            - task_key: silver_demographics
            - task_key: silver_drug_details
            - task_key: silver_indications
            - task_key: silver_outcomes
            - task_key: silver_reactions
            - task_key: silver_reports
            - task_key: silver_therapy_durations

        - task_key: gold_dim_patient
          spark_python_task:
            python_file: "../../src/gold/dims/dim_patient.py"
          job_cluster_key: "pipeline_cluster"
          timeout_seconds: 7200
          depends_on:
            - task_key: gold_dim_date
            - task_key: silver_demographics

        - task_key: gold_dim_drug
          spark_python_task:
            python_file: "../../src/gold/dims/dim_drug.py"
          job_cluster_key: "pipeline_cluster"
          timeout_seconds: 7200
          depends_on:
            - task_key: gold_dim_date
            - task_key: silver_drug_details

        - task_key: gold_dim_report
          spark_python_task:
            python_file: "../../src/gold/dims/dim_report.py"
          job_cluster_key: "pipeline_cluster"
          timeout_seconds: 3600
          depends_on:
            - task_key: gold_dim_date
            - task_key: silver_reports

        - task_key: gold_dim_reaction
          spark_python_task:
            python_file: "../../src/gold/dims/dim_reaction.py"
          job_cluster_key: "pipeline_cluster"
          timeout_seconds: 7200
          depends_on:
            - task_key: gold_dim_date
            - task_key: silver_reactions

        - task_key: gold_dim_indication
          spark_python_task:
            python_file: "../../src/gold/dims/dim_indication.py"
          job_cluster_key: "pipeline_cluster"
          timeout_seconds: 7200
          depends_on:
            - task_key: gold_dim_date
            - task_key: silver_indications

        - task_key: gold_dim_therapy
          spark_python_task:
            python_file: "../../src/gold/dims/dim_therapy.py"
          job_cluster_key: "pipeline_cluster"
          timeout_seconds: 7200
          depends_on:
            - task_key: gold_dim_date
            - task_key: silver_therapy_durations

        - task_key: gold_dim_outcome
          spark_python_task:
            python_file: "../../src/gold/dims/dim_outcome.py"
          job_cluster_key: "pipeline_cluster"
          timeout_seconds: 7200
          depends_on:
            - task_key: gold_dim_date
            - task_key: silver_outcomes

        # Gold layer fact table (depends on all dimensions being complete)
        - task_key: gold_fact_adverse_events
          spark_python_task:
            python_file: "../../src/gold/facts/fact_adverse_events.py"
          job_cluster_key: "pipeline_cluster"
          timeout_seconds: 7200
          depends_on:
            - task_key: gold_dim_date
            - task_key: gold_dim_patient
            - task_key: gold_dim_drug
            - task_key: gold_dim_report
            - task_key: gold_dim_reaction
            - task_key: gold_dim_indication
            - task_key: gold_dim_therapy
            - task_key: gold_dim_outcome
